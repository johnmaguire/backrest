<?xml version="1.0"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

    <?include Variables.wxi ?>

    <Product Id="*" UpgradeCode="12C81A6B-CC57-4767-A7A0-CCB1E60696F4" Version="$(env.ProductVersion)" Name="$(var.ProductName)" Manufacturer="$(var.FullManufacturerName)" Language="1033">

        <Package InstallerVersion="500" InstallScope="perMachine" InstallPrivileges="elevated" Compressed="yes" Id="*" Manufacturer="$(var.FullManufacturerName)" />
        <MajorUpgrade AllowDowngrades="yes" Schedule="afterInstallExecute"/>
        <MediaTemplate EmbedCab="yes"/>

        <UI>
            <UIRef Id="WixUI_InstallDir"/>
            <!-- Hide EULA -->
            <Publish Dialog="WelcomeDlg"
                Control="Next"
                Event="NewDialog"
                Value="InstallDirDlg"
                Order="99">1</Publish>
            <Publish Dialog="InstallDirDlg"
                Control="Back"
                Event="NewDialog"
                Value="WelcomeDlg"
                Order="99">1</Publish>
        </UI>
        <!--
        <Icon Id="AppIcon" SourceFile="Images\icon-256x256.ico"/>
        <Property Id="ARPPRODUCTICON" Value="AppIcon"/>
        -->

        <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR"/>
        <Property Id="INSTALLDIR">
            <!-- Pull the registry key saved during install if exists:
                 http://robmensching.com/blog/posts/2010/5/2/the-wix-toolsets-remember-property-pattern/ -->
            <RegistrySearch Id="RememberProperty" Root="HKLM" Key="SOFTWARE\$(var.ManufacturerName)\$(var.ProductName)" Name="InstallDir" Type="raw"/>
        </Property>

        <!-- Build directory structure -->
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="ProgramFiles64Folder">
                <Directory Id="ManufacturerFolder" Name="$(var.ManufacturerName)">
                    <Directory Id="INSTALLDIR" Name="$(var.ProductName)">
                        <Directory Name="config" Id="ConfigFolder" />
                    </Directory>
                </Directory>
            </Directory>
        </Directory>

        <!-- Go 1.21+ supports Windows 10 / Server 2016 and newer only -->
        <Property Id="WINDOWSBUILDNUMBER" Secure="yes">
            <RegistrySearch Id="BuildNumberSearch" Root="HKLM" Key="SOFTWARE\Microsoft\Windows NT\CurrentVersion" Name="CurrentBuildNumber" Type="raw"/>
        </Property>
        <Condition Message="This application requires Windows Server 2016 / Windows 10 or newer."><![CDATA[Installed OR (VersionNT >= 1000)]]></Condition>

        <!-- Build the feature -->
        <ComponentGroup Id="Daemon">
            <ComponentRef Id="backrestEXEComponent"/>
        </ComponentGroup>
        <ComponentGroup Id="Config">
            <ComponentRef Id="configFolderComponent"/>
        </ComponentGroup>
        <Feature Id="ProductFeature" Title="$(var.ProductName)" Description="Backrest">
            <ComponentGroupRef Id="Daemon"/>
            <ComponentGroupRef Id="Config"/>
            <ComponentRef Id="InstallDirRegistryKey"/>
        </Feature>

        <!-- Build components -->
        <DirectoryRef Id="ProgramFiles64Folder"/>

        <DirectoryRef Id="INSTALLDIR">
            <!-- Save the custom install directory to registry for upgrade -->
            <Component Id="InstallDirRegistryKey">
                <CreateFolder/>
                <RegistryValue Root="HKLM" Key="SOFTWARE\$(var.ManufacturerName)\$(var.ProductName)" Name="InstallDir" Value="[INSTALLDIR]" Type="string"/>
            </Component>
            <Component Id="backrestEXEComponent" Guid="9E2DB921-46C3-41BF-8386-676BB84CF078">
                <?if $(sys.BUILDARCH) = "x64"?>
                    <?define FilePath="..\dist\other_windows_arm64\"?>
                <?elseif $(sys.BUILDARCH) = "arm64"?>
                    <?define FilePath="..\dist\other_windows_amd64_v1\"?>
                <?endif?>
                <File Id="backrestEXE" Name="backrest.exe" Source="$(var.FilePath)"/>
                <ServiceInstall Start="auto" Type="ownProcess" ErrorControl="normal" Name="backrest" DisplayName="Backrest" Description="Web UI and orchestrator for restic backup"/>
                <ServiceControl Start="install" Stop="both" Remove="uninstall" Name="backrest" Id="backrestServiceControl"/>
            </Component>
        </DirectoryRef>

        <!-- Save the command line value INSTALLDIR and restore it later in the sequence or it will be overwritten by the value saved to the registry during an upgrade -->
        <CustomAction Id='SaveCmdLineValueINSTALLDIR' Property='CMDLINE_INSTALLDIR' Value='[INSTALLDIR]' Execute='firstSequence' />
        <CustomAction Id='SetFromCmdLineValueINSTALLDIR' Property='INSTALLDIR' Value='[CMDLINE_INSTALLDIR]' Execute='firstSequence' />
        <InstallUISequence>
            <Custom Action='SaveCmdLineValueINSTALLDIR' Before='AppSearch' />
            <Custom Action='SetFromCmdLineValueINSTALLDIR' After='AppSearch'>
                CMDLINE_INSTALLDIR
            </Custom>
        </InstallUISequence>
        <InstallExecuteSequence>
            <Custom Action='SaveCmdLineValueINSTALLDIR' Before='AppSearch' />
            <Custom Action='SetFromCmdLineValueINSTALLDIR' After='AppSearch'>
                CMDLINE_INSTALLDIR
            </Custom>
        </InstallExecuteSequence>
    </Product>
</Wix>
